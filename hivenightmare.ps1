# CVE-2021-36934 HiveNightmare vulnerability checker and workaround
# Author: Rubén López Herrera (IRIS Sentinel)
#
# This script will check hive system files ACLs and fix them if you wish
# In addition it will check all shadow copies made in the past for the dangerous permissions and delete them if you wish
#     
# Inspiration for method of checking from https://github.com/paragonsec/HiveNightmare-Checker/blob/main/hivechecker.ps1 and
# https://github.com/pyonghe/HiveNightmareChecker/blob/main/hnmchecker.ps1 repositories

#requires -version 4.0
#requires -RunAsAdministrator

Write-Host -ForegroundColor Green "==== CVE-2021-36934 HiveNightmare vulnerability checker and workaround ===="

$osAffected = @("10.0.17763","10.0.18363","10.0.19041","10.0.19042","10.0.19043")
$osVersion = @((Get-WmiObject Win32_OperatingSystem).Version)

# Checking operating system version
If ($osAffected -match $osVersion) {
    
    Write-Host -ForegroundColor Yellow "[!] " -NoNewline ; Write-Host "Windows version $osVersion may be affected by the vulnerability"

    # Checking current hive files access rights
    $samAccess = @((Get-Item -LiteralPath $Env:windir\System32\config\SAM).GetAccessControl().AccessToString)
    $systemAccess = @((Get-Item -LiteralPath $Env:windir\System32\config\SYSTEM).GetAccessControl().AccessToString)
    $securityAccess = @((Get-Item -LiteralPath $Env:windir\System32\config\SECURITY).GetAccessControl().AccessToString)

    # Get the name of the local Users group (depending OS language settings)
    $usersGroupName = @((Get-WmiObject win32_group -Filter "SID='S-1-5-32-545'").Name)

    # ACL to look for that is dangerous
    $userACL = "*BUILTIN\$usersGroupName Allow*"
       
    # if any of the hive files match the dangerous ACL alert the user
    If (($samAccess -like $userACL -And $systemAccess -like $userACL -And $securityAccess -like $userACL)) {
        Write-Host -ForegroundColor Red "[!] " -NoNewline ; Write-Host "Vulnerable ACL rights on hive system files"
        # Set permissions according to Microsoft (https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934)
        icacls $env:windir\system32\config\*.* /inheritance:e | Out-Null
        Write-Host -ForegroundColor Green "[*] " -NoNewline; Write-Host "ACLs have been updated"

        # Check shadow copies and delete them
	    $shdresult = @(vssadmin list shadows)
	    if ($shdresult -like "*\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy*"){
		# Delete shadow copies 
		Write-Host -ForegroundColor Red "[!] " -NoNewline; Write-Host "There are vulnerable shadow copies on the system"
		vssadmin delete shadows /For=$Env:SystemDrive /Quiet | Out-Null
		Write-Host -ForegroundColor Green "[*] " -NoNewline; Write-Host "Shadow copies have been removed"

		# Create new restore point
		Checkpoint-Computer -Description "Restorepoint for CVE-2021-36934 HiveNightmare" -RestorePointType MODIFY_SETTINGS
		Write-Host -ForegroundColor Green "[*] " -NoNewline; Write-Host "A new restore point has been created"
	    } else {
		Write-Host -ForegroundColor Green "[*] " -NoNewline ; Write-Host "No shadow copies found"
	    }
    
        Write-Host -ForegroundColor Green "[*] " -NoNewline ; Write-Host "System is not vulnerable"
    } else {
        Write-Host -ForegroundColor Green "[*] " -NoNewline ; Write-Host "No vulnerable hive system files found"
        Write-Host -ForegroundColor Green "[*] " -NoNewline ; Write-Host "System is not vulnerable"
    }
}
else {
    Write-Host -ForegroundColor Green "[*] " -NoNewline ; Write-Host "Operating System is not vulnerable"
}
